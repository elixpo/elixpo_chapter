name: Claude PR Summarization

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate PR Summary using Pollinations API
        id: summary
        env:
          POLLINATIONS_API_URL: "https://text.pollinations.ai/"
          MODEL: "openai"
          PROMPT: "Summarize the following pull request in 3-4 sentences, focusing on purpose, main changes, and impact."
        run: |
          echo "üß† Collecting PR information..."
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_DIFF=$(curl -s -H "Accept: application/vnd.github.v3.diff" "${{ github.event.pull_request.url }}")

          REQUEST="${PROMPT}\n\nTitle: ${PR_TITLE}\n\nDescription: ${PR_BODY}\n\nDiff:\n${PR_DIFF}"

          echo "üöÄ Sending request to Pollinations API..."
          RESPONSE=$(curl -s -G "${POLLINATIONS_API_URL}" \
            --data-urlencode "model=${MODEL}" \
            --data-urlencode "text=${REQUEST}")

          echo "üßæ Raw API Response:"
          echo "$RESPONSE"

          echo "üß© Checking if the response is valid JSON..."
          if echo "$RESPONSE" | jq empty >/dev/null 2>&1; then
            SUMMARY=$(echo "$RESPONSE" | jq -r '.output // .response // .text // .summary')
            echo "‚úÖ Extracted Summary:"
            echo "$SUMMARY"
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Pollinations API did not return valid JSON. Using raw output as summary."
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$RESPONSE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Comment summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ü§ñ Claude PR Summary"
          message: |
            **Summary generated by Pollinations API:**
            ```
            ${{ steps.summary.outputs.summary }}
            ```
