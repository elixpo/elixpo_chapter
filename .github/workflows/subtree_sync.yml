name: Subtree Sync

on:
  schedule:
    - cron: "0 0,4,8,12,16 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "Circuit-Overtime"
          git config user.email "ayushbhatt633@gmail.com"

      - name: Add remotes (idempotent)
        run: |
          git remote add art.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpoart.git || true
          git remote add jackey.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpojackey.git || true
          git remote add chat.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpochat.git || true
          git remote add blogs.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpoblogs.git || true
          git remote add verse.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpoverse.git || true
          git remote add sketch.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixposketch.git || true
          git remote add me.elixpo https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpome.git || true

      - name: Pull subtrees
        run: |
          git subtree pull --prefix=art.elixpo art.elixpo main -m "Synced art.elixpo"
          git subtree pull --prefix=jackey.elixpo jackey.elixpo main -m "Synced jackey.elixpo"
          git subtree pull --prefix=chat.elixpo chat.elixpo main -m "Synced chat.elixpo"
          git subtree pull --prefix=blogs.elixpo blogs.elixpo main -m "Synced blogs.elixpo"
          git subtree pull --prefix=verse.elixpo verse.elixpo main -m "Synced verse.elixpo"
          git subtree pull --prefix=sketch.elixpo sketch.elixpo main -m "Synced sketch.elixpo"
          git subtree pull --prefix=me.elixpo me.elixpo main -m "Synced me.elixpo"

      - name: Authenticate origin with PAT
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/elixpo/elixpo_chapter.git

      - name: Push updates
        run: |
          git push origin main
