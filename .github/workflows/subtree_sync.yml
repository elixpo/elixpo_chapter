name: Subtree Sync

on:
  schedule:
    - cron: "0 0,4,8,12,16 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add remotes (idempotent)
        run: |
          repos=(
            "art.elixpo https://github.com/elixpo/elixpoart.git"
            "jackey.elixpo https://github.com/elixpo/elixpojackey.git"
            "chat.elixpo https://github.com/elixpo/elixpochat.git"
            "blogs.elixpo https://github.com/elixpo/elixpoblogs.git"
            "verse.elixpo https://github.com/elixpo/elixpoverse.git"
            "sketch.elixpo https://github.com/elixpo/elixposketch.git"
            "me.elixpo https://github.com/elixpo/elixpome.git"
            "accounts.elixpo https://github.com/elixpo/elixpoaccounts.git"
          )

          for entry in "${repos[@]}"; do
            name=${entry%% *}
            url=${entry#* }
            if git remote get-url "$name" >/dev/null 2>&1; then
              echo "remote $name already exists"
            else
              echo "adding remote $name -> $url"
              git remote add "$name" "$url"
            fi
            git fetch "$name" >/dev/null 2>&1 || true
            if [ -d "$name" ] || git ls-tree --name-only HEAD | grep -qx "$name"; then
              echo "subtree $name already present, skipping add"
            else
              echo "adding subtree $name from $name/main"
              git subtree add --prefix="$name" "$name" main -m "Add $name" || true
            fi
          done

      - name: Fetch all subtree remotes
        run: |
          git fetch art.elixpo
          git fetch jackey.elixpo
          git fetch chat.elixpo
          git fetch blogs.elixpo
          git fetch verse.elixpo
          git fetch sketch.elixpo
          git fetch me.elixpo
          git fetch accounts.elixpo

      - name: Pull subtrees
        run: |
          git subtree pull --prefix=art.elixpo art.elixpo main -m "Sync art.elixpo" || true
          git subtree pull --prefix=jackey.elixpo jackey.elixpo main -m "Sync jackey.elixpo" || true
          git subtree pull --prefix=chat.elixpo chat.elixpo main -m "Sync chat.elixpo" || true
          git subtree pull --prefix=blogs.elixpo blogs.elixpo main -m "Sync blogs.elixpo" || true
          git subtree pull --prefix=verse.elixpo verse.elixpo main -m "Sync verse.elixpo" || true
          git subtree pull --prefix=sketch.elixpo sketch.elixpo main -m "Sync sketch.elixpo" || true
          git subtree pull --prefix=me.elixpo me.elixpo main -m "Sync me.elixpo" || true
          git subtree pull --prefix=accounts.elixpo accounts.elixpo main -m "Sync accounts.elixpo" || true

      - name: Push updates
        run: |
          git push origin main
